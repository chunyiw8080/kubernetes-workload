---
apiVersion: v1
kind: ConfigMap
metadata:
  name: benchmark-wrk-config
  namespace: benchmark
data:
  # 目标服务URL
  TARGET_URL: "https://white-festa.net"
  # 线程数
  THREADS: "2"
  # 并发数
  CONCURRENCY: "20"
  # 持续时间(秒)
  DURATION: "60s"
---
apiVersion: batch/v1
kind: Job
metadata:
  name: benchmark-wrk-job
  namespace: benchmark
spec:
  completions: 2
  parallelism: 2
  backoffLimit: 0

  # ⭐ 最大运行时间
  # activeDeadlineSeconds: 300

  template:
    metadata:
      labels:
        app: benchmark-wrk-job
    spec:
      restartPolicy: Never
      # 通过拓扑约束，确保Pod分布在不同节点上
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchLabels:
                app: benchmark-wrk-job
            topologyKey: kubernetes.io/hostname

      containers:
      - name: benchmark-wrk-job
        image: docker.io/chunyiwang/wrk:4.2.0
        imagePullPolicy: IfNotPresent
        args:
          - "--latency"
          - "-t$(THREADS)"
          - "-c$(CONCURRENCY)"
          - "-d$(DURATION)"
          - "$(TARGET_URL)"
        env:
        - name: THREADS
          valueFrom:
            configMapKeyRef:
              name: benchmark-wrk-config
              key: THREADS
        - name: CONCURRENCY
          valueFrom:
            configMapKeyRef:
              name: benchmark-wrk-config
              key: CONCURRENCY
        - name: DURATION
          valueFrom:
            configMapKeyRef:
              name: benchmark-wrk-config
              key: DURATION
        - name: TARGET_URL
          valueFrom:
            configMapKeyRef:
              name: benchmark-wrk-config
              key: TARGET_URL
        resources:
          requests:
            cpu: 500m
          limits:
            cpu: 1